syntax = "proto3";
package worker_rpc;
import "google/protobuf/empty.proto";

service WorkerRPCService {
  rpc RegisterQuery (RegisterQueryRequest) returns (RegisterQueryReply) {}
  rpc UnregisterQuery (UnregisterQueryRequest) returns (google.protobuf.Empty) {}

  rpc StartQuery (StartQueryRequest) returns (google.protobuf.Empty) {}
  rpc StopQuery (StopQueryRequest) returns (google.protobuf.Empty) {}

  rpc RequestQueryStatus (QueryStatusRequest) returns (QueryStatusReply) {}
  rpc RequestQueryLog (QueryLogRequest) returns (QueryLogReply) {}
  rpc RequestStatus (WorkerStatusRequest) returns (WorkerStatusResponse) {}
}

message RegisterQueryRequest {
  uint64 queryId = 1;
}

message RegisterQueryReply {
}

message UnregisterQueryRequest {
  uint64 queryId = 1;
}

message StartQueryRequest {
  uint64 queryId = 1;
}

message StopQueryRequest {
  enum QueryTerminationType {Graceful = 0; HardStop = 1; Failure = 2; Invalid = 3;};
  uint64 queryId = 2;
  QueryTerminationType terminationType = 3;
}

enum QueryState {
  Registered = 0;
  Started = 1;
  Running = 2;
  Stopped = 3;
  Failed = 4;
}

message Error {
  uint64 code = 1;
  string message = 2;
  string stackTrace = 3; /// currently untyped
  string location = 4; /// currently untyped
}

message QueryStatusRequest {
  uint64 queryId = 1;
}

message QueryMetrics {
  optional uint64 startUnixTimeInMs = 1;
  optional uint64 runningUnixTimeInMs = 2;
  optional uint64 stopUnixTimeInMs = 3;
  optional Error error = 4;
}

message QueryStatusReply {
  uint64 queryId = 1;
  QueryState state = 2;
  QueryMetrics metrics = 3;
}

message QueryLogRequest {
  uint64 queryId = 1;
}

message QueryLogEntry {
  QueryState state = 1;
  uint64 unixTimeInMs = 2;
  optional Error error = 3;
}

message QueryLogReply {
  repeated QueryLogEntry entries = 1;
}

message WorkerStatusRequest {
  uint64 afterUnixTimestampInMs = 1;
}

message WorkerStatusResponse {
  message ActiveQuery {
    uint64 queryId = 1;
    uint64 startedUnixTimestampInMs = 2;
  }

  message TerminatedQuery {
    uint64 queryId = 1;
    uint64 startedUnixTimestampInMs = 2;
    uint64 terminatedUnixTimestampInMs = 3;
    optional Error error = 4;
  }

  uint64 afterUnixTimestampInMs = 3;
  uint64 untilUnixTimestampInMs = 4;
  repeated ActiveQuery activeQueries = 1;
  repeated TerminatedQuery terminatedQueries = 2;
}